<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>PEEL Workspace - CR_M2</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #f4f7f6;
            display: flex;
            height: 100vh;
            margin: 0;
            color: #333;
        }

        .main {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
        }

        .sidebar {
            width: 340px;
            background: #fff;
            border-left: 1px solid #dee2e6;
            padding: 25px;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.05);
            overflow-y: auto;
        }

        .sidebar.hidden {
            display: none;
        }

        .header {
            border-bottom: 3px solid #1d3557;
            margin-bottom: 30px;
            padding-bottom: 15px;
        }

        .q-text {
            font-size: 20px;
            font-weight: 700;
            color: #1d3557;
        }

        .nav-bar {
            margin-bottom: 25px;
            display: flex;
            gap: 10px;
        }

        button {
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            color: white;
            transition: 0.2s;
        }

        .btn-save {
            background: #2a9d8f;
        }

        .btn-export {
            background: #f4a261;
        }

        .btn-menu {
            background: #457b9d;
        }

        button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .editor-box {
            margin-bottom: 20px;
        }

        .label {
            color: #e63946;
            font-size: 11px;
            font-weight: 800;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        textarea {
            width: 100%;
            height: 95px;
            border: 1.5px solid #ced4da;
            border-radius: 8px;
            padding: 12px;
            font-size: 14px;
            resize: none;
            line-height: 1.5;
        }

        .kb-section {
            margin-bottom: 25px;
        }

        .sec-title {
            font-size: 12px;
            font-weight: 800;
            color: #1d3557;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .tag-group {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .tag {
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            border: 1px solid #ddd;
            background: #fff;
            transition: 0.2s;
            border-left: 4px solid #ddd;
        }

        .tag:hover {
            background: #1d3557;
            color: white;
            transform: scale(1.05);
        }

        .ctx {
            border-left-color: #457b9d;
        }

        .entity {
            border-left-color: #e63946;
        }

        .impact {
            border-left-color: #2a9d8f;
        }

        .hist {
            border-left-color: #8338ec;
        }
    </style>
</head>

<body>
    <div class="main">
        <div class="nav-bar">
            <button class="btn-save" onclick="save()">üíæ SAVE</button>
            <button class="nav-btn ai-btn" id="ai-btn" onclick="reviewAI()"
                style="background: #007bff; color: white;">ü§ñ AI Review</button>
            <select id="language-setting"
                style="padding: 10px; border-radius: 6px; border: 1.5px solid #007bff; background: white; font-weight: 600; cursor: pointer;">
                <option value="dual" selected>üåì ÂèåËØ≠ (Bilingual)</option>
                <option value="en">üá¨üáß Â§ñÊïô (English Only)</option>
                <option value="zh">üá®üá≥ ‰∏≠Êïô (Chinese)</option>
            </select>
            <button class="btn-export" onclick="exportDoc()">üì• EXPORT</button>
            <button class="btn-menu" onclick="location.href='../../index.html'">üè† MENU</button>
            <button class="btn-menu" style="background:#6c757d;" onclick="toggleHub()">üìÇ HUB</button>
        </div>

        <div class="header">
            <div style="color:#6c757d; font-size:11px; margin-bottom:5px;">MISSION ID: CR_M2</div>
            <div class="q-text">Evaluate how successful the Civil Rights movement was in the 1950s.</div>
        </div>

        <div class="editor-box">
            <div class="label">1. Point (Thesis Statement)</div><textarea id="p"></textarea>
        </div>
        <div class="editor-box">
            <div class="label">2. Evidence 1 + Mechanism</div><textarea id="e1"></textarea>
        </div>
        <div class="editor-box">
            <div class="label">3. Evidence 2 + Mechanism</div><textarea id="e2"></textarea>
        </div>
        <div class="editor-box">
            <div class="label">4. Link Back</div><textarea id="l"></textarea>
        </div>

        <div id="ai-review-result"
            style="display: none; margin-top: 30px; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.15); border: 1px solid #ddd;">
            <div
                style="background: #2d3436; color: white; padding: 12px 20px; font-weight: bold; display: flex; justify-content: space-between; align-items: center;">
                <span>ü§ñ AI TEACHER'S REVIEW</span>
                <button onclick="document.getElementById('ai-review-result').style.display='none'"
                    style="background:none; border:none; color:white; cursor:pointer; font-size:20px;">√ó</button>
            </div>
            <div id="ai-content"
                style="background: #fff; padding: 25px; line-height: 1.8; color: #2d3436; min-height: 100px; white-space: pre-wrap;">
                AI is thinking...</div>
        </div>
    </div>

    <div class="sidebar">
        <h3 style="margin:0 0 20px 0; color:#1d3557;">Knowledge Hub (V2.1)</h3>
        <div class="kb-section">
            <div class="sec-title">‚öñÔ∏è LEGAL MILESTONES</div>
            <div class="tag-group">
                <div class="tag ctx" onclick="add('Plessy v. Ferguson')"
                    oncontextmenu="window.explain(event, 'Plessy v. Ferguson')">Plessy v. Ferguson</div>
                <div class="tag ctx" onclick="add('Brown v. Board')"
                    oncontextmenu="window.explain(event, 'Brown v. Board')">Brown v. Board</div>
                <div class="tag ctx" onclick="add('Brown II (1955)')"
                    oncontextmenu="window.explain(event, 'Brown II (1955)')">Brown II</div>
                <div class="tag ctx" onclick="add('1957 Civil Rights Act')"
                    oncontextmenu="window.explain(event, 'Civil Rights Act of 1957')">1957 CR Act</div>
            </div>
        </div>
        <div class="kb-section">
            <div class="sec-title">‚úä DIRECT ACTION</div>
            <div class="tag-group">
                <div class="tag entity" onclick="add('Bus Boycott')"
                    oncontextmenu="window.explain(event, 'Montgomery Bus Boycott')">Bus Boycott</div>
                <div class="tag entity" onclick="add('Little Rock 9')"
                    oncontextmenu="window.explain(event, 'Little Rock Nine')">Little Rock 9</div>
                <div class="tag entity" onclick="add('Emmett Till')"
                    oncontextmenu="window.explain(event, 'Emmett Till Murder')">Emmett Till</div>
            </div>
        </div>
        <div class="kb-section">
            <div class="sec-title">üìä EVALUATION</div>
            <div class="tag-group">
                <div class="tag hist" onclick="add('De Jure Segregation')"
                    oncontextmenu="window.explain(event, 'De Jure Segregation')">De Jure</div>
                <div class="tag hist" onclick="add('Grassroots Activism')"
                    oncontextmenu="window.explain(event, 'Grassroots Activism')">Grassroots</div>
                <div class="tag hist" onclick="add('Federal Power')"
                    oncontextmenu="window.explain(event, 'Federal Intervention')">Federal Power</div>
            </div>
        </div>
    </div>

    <script>
        const ID = "CR_M2";
        let activeEditor = document.getElementById('p');

        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('textarea').forEach(tx => { tx.onfocus = () => activeEditor = tx; });
            const d = JSON.parse(localStorage.getItem(ID) || '{}');
            if (d.p) document.getElementById('p').value = d.p;
            if (d.e1) document.getElementById('e1').value = d.e1;
            if (d.e2) document.getElementById('e2').value = d.e2;
            if (d.l) document.getElementById('l').value = d.l;
        });

        function add(text) {
            const start = activeEditor.selectionStart;
            activeEditor.value = activeEditor.value.substring(0, start) + text + " " + activeEditor.value.substring(start);
            activeEditor.focus();
        }

        window.explain = async function (event, topic) {
            if (event) event.preventDefault();
            const resultDiv = document.getElementById('ai-review-result');
            const contentDiv = document.getElementById('ai-content');
            resultDiv.style.display = 'block';
            contentDiv.innerText = `üîç Ê≠£Âú®Ë∞ÉÂèñÂè≤ÊñôËß£Êûê„Äå${topic}„Äç...`;
            resultDiv.scrollIntoView({ behavior: 'smooth' });
            try {
                const response = await fetch('/api/explain', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topic: topic })
                });
                const data = await response.json();
                contentDiv.innerText = data.explanation || "Êú™Êî∂Âà∞ÊúâÊïàËß£Êûê„ÄÇ";
            } catch (error) {
                contentDiv.innerText = "‚ùå Êó†Ê≥ïËøûÊé• AI Êé•Âè£„ÄÇ";
            }
        };

        async function reviewAI() {
            const btn = document.getElementById('ai-btn');
            const resultDiv = document.getElementById('ai-review-result');
            const contentDiv = document.getElementById('ai-content');
            const data = { point: document.getElementById('p').value, evidence1: document.getElementById('e1').value, evidence2: document.getElementById('e2').value, link: document.getElementById('l').value };
            btn.innerText = "‚åõ Thinking..."; btn.disabled = true;
            resultDiv.style.display = 'block';
            try {
                const response = await fetch('/api/review', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                const result = await response.json();
                contentDiv.innerText = result.review || "ÂèçÈ¶àÁîüÊàêÂ§±Ë¥•";
            } catch (e) { contentDiv.innerText = "‚ö†Ô∏è ËøûÊé•Â§±Ë¥•"; }
            finally { btn.innerText = "ü§ñ AI Review"; btn.disabled = false; }
        }

        function save() {
            const data = { p: document.getElementById('p').value, e1: document.getElementById('e1').value, e2: document.getElementById('e2').value, l: document.getElementById('l').value };
            localStorage.setItem(ID, JSON.stringify(data));
            alert("Draft Saved!");
        }
        function toggleHub() { document.querySelector('.sidebar').classList.toggle('hidden'); }
        function exportDoc() {
            const content = `POINT: ${document.getElementById('p').value}\nEVIDENCE: ${document.getElementById('e1').value}`;
            const blob = new Blob([content], { type: 'text/plain' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${ID}.txt`; a.click();
        }
    </script>
</body>

</html>