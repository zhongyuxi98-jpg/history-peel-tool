<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PEEL Workspace - CR_M4</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; display: flex; height: 100vh; margin: 0; color: #333; }
        .main { flex: 1; padding: 40px; overflow-y: auto; }

        /* å³ä¾§åŒçª—å£ï¼šä¸Šæ–¹çŸ¥è¯†åŒºå¯æ»šåŠ¨ï¼›ä¸‹æ–¹ explainer-window å›ºå®š */
        .sidebar {
            width: 380px;
            background: #fff;
            border-left: 1px solid #dee2e6;
            padding: 25px;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            gap: 14px;
            box-sizing: border-box;
        }
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding-right: 6px; /* ç»™æ»šåŠ¨æ¡ç•™ç©ºé—´ */
        }
        .header { border-bottom: 3px solid #1d3557; margin-bottom: 25px; padding-bottom: 15px; }
        .q-text { font-size: 20px; font-weight: 700; color: #1d3557; }
        .nav-bar { margin-bottom: 25px; display: flex; gap: 10px; }
        
        button { border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-save { background: #2a9d8f; color: white; padding: 10px 18px; }
        .btn-export { background: #f4a261; color: white; padding: 10px 18px; }

        /* Section tabs (minimal style) */
        .section-tabs { display: flex; gap: 8px; margin: 12px 0 18px 0; }
        .section-tab { padding: 8px 12px; border-radius: 999px; border: 1px solid #ced4da; background: #fff; color: #1d3557; font-size: 13px; }
        .section-tab.active { background: #1d3557; color: #fff; border-color: #1d3557; }
        .section-hint { color:#6c757d; font-size:12px; margin-bottom: 10px; }
        
        /* ğŸ’¡ æ˜¾å¼æŒ‰é’®æ ·å¼ */
        .tag-row { display: flex; align-items: center; gap: 5px; margin-bottom: 8px; }
        .tag { flex: 1; padding: 8px; border-radius: 4px; font-size: 12px; cursor: pointer; border: 1px solid #ddd; background: #fff; border-left: 4px solid #457b9d; text-align: left; }
        .tag:hover { background: #f8f9fa; }
        .explain-btn { background: #457b9d; color: white; padding: 8px; font-size: 12px; border-radius: 4px; width: 35px; }
        
        .editor-box { margin-bottom: 15px; }
        .label { color: #e63946; font-size: 11px; font-weight: 800; text-transform: uppercase; margin-bottom: 5px; }
        textarea { width: 100%; height: 95px; border: 1.5px solid #ced4da; border-radius: 8px; padding: 12px; font-size: 14px; resize: none; line-height: 1.5; box-sizing: border-box; }
        
        /* ğŸ‘¨â€ğŸ« å³ä¾§è®²è§£è€å¸ˆçª—å£ */
        #explainer-window {
            position: sticky;
            bottom: 0;
            background: #1d3557; /* è“è‰²çª—å£ */
            border-radius: 12px;
            padding: 14px 14px 12px 14px;
            border: 1px solid rgba(255,255,255,0.18);
            box-shadow: 0 10px 30px rgba(29,53,87,0.25);
        }
        #explain-box { font-size: 13px; line-height: 1.6; color: #f1faee; min-height: 110px; white-space: pre-wrap; }

        /* ğŸš€ åº•éƒ¨ AI Review æ ·å¼ */
        .ai-review-trigger { background: #e63946; color: white; width: 100%; padding: 20px; font-size: 18px; margin: 30px 0; box-shadow: 0 4px 15px rgba(230,57,70,0.3); }
        #ai-review-result { border: 2px solid #e63946; border-radius: 12px; background: white; margin-bottom: 40px; overflow: hidden; }
    </style>
</head>

<body>
    <div class="main">
        <div class="nav-bar">
            <button class="btn-save" onclick="save()">ğŸ’¾ SAVE</button>
            <select id="language-setting" style="padding: 10px; border-radius: 6px; border: 1.5px solid #007bff;">
                <option value="dual" selected>ğŸŒ“ Dual-Language</option>
                <option value="en">ğŸ‡¬ğŸ‡§ English Only</option>
                <option value="zh">ğŸ‡¨ğŸ‡³ Chinese Only</option>
            </select>
            <button class="btn-export" onclick="exportDoc()">ğŸ“¥ EXPORT + FEEDBACK</button>
        </div>

        <div class="header">
            <div style="color:#6c757d; font-size:11px; margin-bottom:5px;">MISSION ID: CR_M4</div>
            <div style="display:flex; align-items:center; gap:10px;">
                <h1 class="q-text" id="question-title" contenteditable="true" spellcheck="false" style="outline:none; margin:0; flex:1;">Analyse the effectiveness of the NAACP in promoting civil rights in the late 1940s and 1950s.</h1>
                <span title="Click to edit the question" style="font-size:18px; color:#457b9d;">âœï¸</span>
            </div>
        </div>

        <div class="section-tabs" role="tablist" aria-label="Section type">
            <button class="section-tab" id="tab-intro" onclick="setSectionType('intro')">Intro</button>
            <button class="section-tab active" id="tab-body" onclick="setSectionType('body')">Body (PEEL)</button>
            <button class="section-tab" id="tab-conclusion" onclick="setSectionType('conclusion')">Conclusion</button>
        </div>
        <div class="section-hint" id="section-hint">Body mode: write a PEEL paragraph (Point â†’ Evidence â†’ Explanation â†’ Link).</div>

        <div class="editor-box"><div class="label">1. Point</div><textarea id="p"></textarea></div>
        <div class="editor-box"><div class="label">2. Evidence 1</div><textarea id="e1"></textarea></div>
        <div class="editor-box"><div class="label">3. Evidence 2</div><textarea id="e2"></textarea></div>
        <div class="editor-box"><div class="label">4. Link Back</div><textarea id="l"></textarea></div>

        <button class="ai-review-trigger" id="ai-btn" onclick="submitReview()">ğŸš€ SUBMIT FOR AI TEACHER'S REVIEW</button>

        <div id="ai-review-result" style="display: none;">
            <div style="background: #e63946; color: white; padding: 12px 20px; font-weight: bold;">ğŸ¯ ACADEMIC REVIEW</div>
            <div id="ai-content" style="padding: 25px; line-height: 1.8; font-size: 15px;">AI is analyzing...</div>
        </div>
    </div>

    <div class="sidebar">
        <div class="sidebar-content">
            <h3 style="margin:0 0 14px 0; color:#1d3557;">Knowledge Hub</h3>
            
            <div class="kb-section">
                <div style="font-size:12px; font-weight:800; color:#1d3557; margin-bottom:10px; border-bottom:1px solid #eee;">âš–ï¸ LEGAL MILESTONES</div>
                <div class="tag-row"><div class="tag" onclick="add('Brown v. Board (1954)')">Brown v. Board</div><button class="explain-btn" onclick="getExplanation('Brown v. Board')">ğŸ’¡</button></div>
                <div class="tag-row"><div class="tag" onclick="add('Civil Rights Act (1957)')">1957 CR Act</div><button class="explain-btn" onclick="getExplanation('Civil Rights Act 1957')">ğŸ’¡</button></div>
            </div>

            <div class="kb-section" style="margin-top:20px;">
                <div style="font-size:12px; font-weight:800; color:#1d3557; margin-bottom:10px; border-bottom:1px solid #eee;">âœŠ DIRECT ACTION</div>
                <div class="tag-row"><div class="tag" onclick="add('Montgomery Bus Boycott (1955â€“56)')">Bus Boycott</div><button class="explain-btn" onclick="getExplanation('Montgomery Bus Boycott')">ğŸ’¡</button></div>
                <div class="tag-row"><div class="tag" onclick="add('Little Rock Nine (1957)')">Little Rock 9</div><button class="explain-btn" onclick="getExplanation('Little Rock Nine')">ğŸ’¡</button></div>
                <div class="tag-row"><div class="tag" onclick="add('Jim Crow laws')">Jim Crow</div><button class="explain-btn" onclick="getExplanation('Jim Crow laws')">ğŸ’¡</button></div>
            </div>
        </div>

        <div id="explainer-window">
            <div style="font-weight:800; color:#a8dadc; font-size:11px; margin-bottom:8px; display:flex; justify-content:space-between;">
                <span>ğŸ‘¨â€ğŸ« KNOWLEDGE EXPLORER</span>
                <span style="cursor:pointer" onclick="document.getElementById('explain-box').innerText='Select a topic...'">Reset</span>
            </div>
            <div id="explain-box">Click the ğŸ’¡ button for detailed context.</div>
        </div>
    </div>

    <script>
        const ID = "CR_M4";
        let activeEditor = document.getElementById('p');
        document.querySelectorAll('textarea').forEach(tx => { tx.onfocus = () => activeEditor = tx; });

        // --- 0. è¯­è¨€æ¨¡å¼æ§åˆ¶ ---
        let currentLanguageMode = document.getElementById('language-setting').value || 'dual';
        document.getElementById('language-setting').addEventListener('change', (e) => {
            currentLanguageMode = e.target.value;
            saveToLocal();
        });

        // --- 0.1 æ®µè½ç±»å‹æ§åˆ¶ï¼ˆé»˜è®¤ Bodyï¼‰ ---
        let currentSectionType = 'body';
        function setSectionType(t) {
            currentSectionType = t;
            document.getElementById('tab-intro').classList.toggle('active', t === 'intro');
            document.getElementById('tab-body').classList.toggle('active', t === 'body');
            document.getElementById('tab-conclusion').classList.toggle('active', t === 'conclusion');
            const hint = document.getElementById('section-hint');
            if (t === 'intro') hint.innerText = "Intro mode: focus on a clear thesis + line of argument.";
            else if (t === 'conclusion') hint.innerText = "Conclusion mode: summarise your key points and link back to the question.";
            else hint.innerText = "Body mode: write a PEEL paragraph (Point â†’ Evidence â†’ Explanation â†’ Link).";
            saveToLocal();
        }

        // --- 0.2 è‡ªåŠ¨ä¿å­˜ / æ¢å¤ï¼ˆé˜²åˆ·æ–°ä¸¢å¤±ï¼‰---
        const STORAGE_KEY = `GGV1_STATE::${ID}`;
        let saveDebounceTimer = null;

        function getState() {
            return {
                question: getCurrentQuestion(),
                p: document.getElementById('p').value,
                e1: document.getElementById('e1').value,
                e2: document.getElementById('e2').value,
                l: document.getElementById('l').value,
                language: currentLanguageMode,
                section: currentSectionType,
                updatedAt: Date.now()
            };
        }

        function saveToLocal() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(getState()));
            } catch (e) {}
        }

        function scheduleSave() {
            if (saveDebounceTimer) clearTimeout(saveDebounceTimer);
            saveDebounceTimer = setTimeout(() => saveToLocal(), 2000);
        }

        function loadFromLocal() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                if (!raw) return;
                const s = JSON.parse(raw);
                if (s.question) document.getElementById('question-title').innerText = s.question;
                if (typeof s.p === 'string') document.getElementById('p').value = s.p;
                if (typeof s.e1 === 'string') document.getElementById('e1').value = s.e1;
                if (typeof s.e2 === 'string') document.getElementById('e2').value = s.e2;
                if (typeof s.l === 'string') document.getElementById('l').value = s.l;
                if (s.language) {
                    currentLanguageMode = s.language;
                    document.getElementById('language-setting').value = s.language;
                }
                if (s.section) setSectionType(s.section);
            } catch (e) {}
        }

        document.getElementById('question-title').addEventListener('blur', () => saveToLocal());
        document.querySelectorAll('textarea').forEach(tx => {
            tx.addEventListener('input', scheduleSave);
        });

        function getLanguageConstraint() {
            if (currentLanguageMode === 'en') return "Constraint: You must respond in 100% English. Do not use any Chinese characters.";
            if (currentLanguageMode === 'zh') return "çº¦æŸï¼šå¿…é¡» 100% ä½¿ç”¨ä¸­æ–‡å›ç­”ï¼Œå³ä½¿é—®é¢˜æ˜¯è‹±æ–‡ã€‚";
            return "çº¦æŸï¼šä½¿ç”¨åŒè¯­å›ç­”ã€‚é‡‡ç”¨â€˜ä¸­æ–‡æ ¸å¿ƒè§£é‡Š + æ‹¬å·å†…å¯¹åº”è‹±æ–‡ä¸“ä¸šæœ¯è¯­â€™çš„æ ¼å¼ã€‚";
        }

        function getCurrentQuestion() {
            const title = document.getElementById('question-title');
            const text = (title?.innerText || "").trim();
            return text || "Analyse the effectiveness of the NAACP in promoting civil rights in the late 1940s and 1950s.";
        }

        function add(text) {
            const start = activeEditor.selectionStart;
            activeEditor.value = activeEditor.value.substring(0, start) + text + " " + activeEditor.value.substring(start);
            activeEditor.focus();
        }

        // --- 1. ä¾§è¾¹æ è®²è§£è€å¸ˆ ---
        async function getExplanation(topic) {
            const box = document.getElementById('explain-box');
            const lang = currentLanguageMode;
            const constraint = getLanguageConstraint();
            const essay_question = getCurrentQuestion();
            box.innerHTML = `<i style="color:#666">ğŸ” Searching...</i>`;
            try {
                const response = await fetch('/api/explain', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        topic,
                        language: lang,
                        essay_question,
                        section_type: currentSectionType,
                        constraint
                    })
                });
                const result = await response.json();
                box.innerText = result.explanation || "No explanation found.";
            } catch (e) { box.innerText = "âš ï¸ Connection error."; }
        }

        // --- 2. åº•éƒ¨æ‰¹æ”¹åŠŸèƒ½ ---
        async function submitReview() {
            const btn = document.getElementById('ai-btn');
            const resultDiv = document.getElementById('ai-review-result');
            const contentDiv = document.getElementById('ai-content');
            const essay_question = getCurrentQuestion();
            const constraint = getLanguageConstraint();
            const data = { 
                point: document.getElementById('p').value, 
                evidence1: document.getElementById('e1').value, 
                evidence2: document.getElementById('e2').value, 
                link: document.getElementById('l').value,
                essay_question,
                section_type: currentSectionType,
                language: currentLanguageMode,
                constraint
            };
            
            btn.innerText = "âŒ› Teacher is grading..."; btn.disabled = true;
            resultDiv.style.display = 'block';
            resultDiv.scrollIntoView({ behavior: 'smooth' });

            try {
                const response = await fetch('/api/review', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(data) 
                });
                const result = await response.json();
                contentDiv.innerText = result.review || "Feedback failed.";
            } catch (e) { contentDiv.innerText = "âš ï¸ Connection failed."; }
            finally { btn.innerText = "ğŸš€ SUBMIT FOR AI TEACHER'S REVIEW"; btn.disabled = false; }
        }

        function save() {
            const data = { p: document.getElementById('p').value, e1: document.getElementById('e1').value, e2: document.getElementById('e2').value, l: document.getElementById('l').value };
            localStorage.setItem(ID, JSON.stringify(data));
            alert("Work Saved!");
        }

        function exportDoc() {
            const aiContent = document.getElementById('ai-content').innerText;
            const content = `WORK: ${ID}\nP: ${document.getElementById('p').value}\nE1: ${document.getElementById('e1').value}\nE2: ${document.getElementById('e2').value}\nL: ${document.getElementById('l').value}\n\n[AI FEEDBACK]\n${aiContent}`;
            const blob = new Blob([content], { type: 'text/plain' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Submission_${ID}.txt`; a.click();
        }

        // åˆå§‹æ¢å¤
        window.addEventListener('load', () => {
            loadFromLocal();
        });
    </script>
</body>
</html>